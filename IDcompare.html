<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ID Extractor & Comparator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for overflow and modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #2d3748;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #4b5563;
      width: 80%;
      max-width: 500px;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4 text-center">ID Extractor & Comparator</h1>

    <!-- Input Section -->
    <div class="mb-6">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Upload Files (Multiple Allowed)</label>
        <input type="file" id="fileInput" multiple
          class="w-full p-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Paste Text</label>
        <textarea id="pasteInput" placeholder="Paste text here..."
          class="w-full p-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[100px]"></textarea>
        <input type="text" id="pasteName" placeholder="Custom name for pasted content (optional)"
          class="mt-2 w-full p-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <button id="addPaste" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md mr-2">Add Pasted Content</button>
      <button id="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md">Submit</button>
    </div>

    <!-- Lists Preview -->
    <div id="listsPreview" class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Added Lists</h2>
      <ul id="listNames" class="list-disc list-inside text-gray-300"></ul>
    </div>

    <!-- Comparison Dropdowns (for 3+ lists) -->
    <div id="comparisonSelect" class="mb-4 hidden">
      <h2 class="text-lg font-semibold mb-2">Select Lists to Compare</h2>
      <div class="flex flex-wrap gap-4">
        <select id="firstList" class="flex-1 min-w-[150px] p-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
        <select id="secondList" class="flex-1 min-w-[150px] p-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
      </div>
    </div>

    <!-- Results Section -->
    <div id="results" class="mb-6 hidden">
      <h2 class="text-lg font-semibold mb-2">Results</h2>

      <div id="allLists" class="mb-4 hidden">
        <h3 class="text-md font-medium mb-1">In All Lists</h3>
        <div class="flex gap-2 mb-2">
          <button data-type="all" class="copy-btn px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-sm">Copy as Text</button>
          <button data-type="all" class="open-url-btn px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-sm">Open URL</button>
        </div>
        <div id="allIDs" class="whitespace-pre-wrap break-words text-gray-300 max-h-60 overflow-y-auto p-2 border border-gray-700 rounded"></div>
      </div>

      <div id="comparisonResults" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <h3 class="text-md font-medium mb-1">In Both</h3>
          <div class="flex gap-2 mb-2">
            <button data-type="both" class="copy-btn px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-sm">Copy as Text</button>
            <button data-type="both" class="open-url-btn px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-sm">Open URL</button>
          </div>
          <div id="bothIDs" class="whitespace-pre-wrap break-words text-gray-300 max-h-60 overflow-y-auto p-2 border border-gray-700 rounded"></div>
        </div>
        <div>
          <h3 class="text-md font-medium mb-1" id="onlyFirstLabel">Only in First</h3>
          <div class="flex gap-2 mb-2">
            <button data-type="onlyFirst" class="copy-btn px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-sm">Copy as Text</button>
            <button data-type="onlyFirst" class="open-url-btn px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-sm">Open URL</button>
          </div>
          <div id="onlyFirstIDs" class="whitespace-pre-wrap break-words text-gray-300 max-h-60 overflow-y-auto p-2 border border-gray-700 rounded"></div>
        </div>
        <div>
          <h3 class="text-md font-medium mb-1" id="onlySecondLabel">Only in Second</h3>
          <div class="flex gap-2 mb-2">
            <button data-type="onlySecond" class="copy-btn px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-sm">Copy as Text</button>
            <button data-type="onlySecond" class="open-url-btn px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-sm">Open URL</button>
          </div>
          <div id="onlySecondIDs" class="whitespace-pre-wrap break-words text-gray-300 max-h-60 overflow-y-auto p-2 border border-gray-700 rounded"></div>
        </div>
      </div>
    </div>

    <!-- Modal for ID Details -->
    <div id="idModal" class="modal">
      <div class="modal-content">
        <span class="close float-right text-gray-400 hover:text-gray-100 cursor-pointer text-2xl">&times;</span>
        <h2 class="text-lg font-semibold mb-2">ID Details</h2>
        <p class="mb-2">ID: <span id="modalID"></span></p>
        <div class="mb-2">
          <h3 class="text-md font-medium">Found In:</h3>
          <ul id="foundIn" class="list-disc list-inside text-gray-300"></ul>
        </div>
        <div>
          <h3 class="text-md font-medium">Not Found In:</h3>
          <ul id="notFoundIn" class="list-disc list-inside text-gray-300"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let lists = {};
      let pasteCount = 0;

      // Console test for comparison logic
      function runComparisonTest() {
        console.log('Running test for 8-digit number comparison logic...');
        // Hardcoded test data: two lists of 8-digit numbers
        const testList1 = new Set(['12345678', '23456789', '34567890', '45678901']);
        const testList2 = new Set(['23456789', '34567890', '56789012', '67890123']);
        
        // Compute overlapping and unique numbers
        const overlapping = new Set([...testList1].filter(x => testList2.has(x)));
        const uniqueToList1 = new Set([...testList1].filter(x => !testList2.has(x)));
        const uniqueToList2 = new Set([...testList2].filter(x => !testList1.has(x)));
        
        // Log results to console
        console.log('Test List 1:', Array.from(testList1));
        console.log('Test List 2:', Array.from(testList2));
        console.log('Overlapping Numbers (in both lists):', Array.from(overlapping));
        console.log('Unique to List 1:', Array.from(uniqueToList1));
        console.log('Unique to List 2:', Array.from(uniqueToList2));
        console.log('Comparison logic test completed.');
      }
      // Run the test on page load
      runComparisonTest();

      // Add pasted content to lists
      document.getElementById('addPaste').addEventListener('click', () => {
        const pasteInput = document.getElementById('pasteInput');
        const pasteName = document.getElementById('pasteName').value.trim();
        if (pasteInput.value.trim() === '') {
          alert('Please paste some content first.');
          return;
        }
        pasteCount++;
        const name = pasteName || `Paste ${pasteCount}`;
        lists[name] = pasteInput.value;
        updateListPreview();
        pasteInput.value = '';
        document.getElementById('pasteName').value = '';
        // Alert removed as per request
      });

      // Handle file uploads
      document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
            lists[file.name] = event.target.result;
            updateListPreview();
          };
          reader.onerror = () => alert(`Error reading file: ${file.name}`);
          reader.readAsText(file);
        });
        e.target.value = ''; // Reset input
      });

      // Update preview of added lists
      function updateListPreview() {
        const listNames = Object.keys(lists);
        const ul = document.getElementById('listNames');
        ul.innerHTML = listNames.length > 0 ? listNames.map(name => `<li>${name}</li>`).join('') : '<li>No lists added yet.</li>';
      }

      // Submit and process lists
      document.getElementById('submit').addEventListener('click', () => {
        const listNames = Object.keys(lists);
        console.log('Number of lists on submit:', listNames.length); // Debug log to check list count
        console.log('List names:', listNames); // Debug log to check list names
        if (listNames.length < 2) {
          alert('Please add at least two lists (files or pasted content) to compare.');
          return;
        }
        // Proceed with comparison for 2 or more lists
        console.log('Proceeding with comparison for lists:', listNames); // Debug log to confirm execution

        // Extract 8-digit IDs from each list
        const idSets = {};
        listNames.forEach(name => {
          const text = lists[name];
          const matches = text.match(/\b\d{8}\b/g) || [];
          idSets[name] = new Set(matches);
          console.log(`IDs extracted from ${name}:`, Array.from(idSets[name])); // Debug log for extracted IDs as Set
        });

        // Compute intersection of all lists and conditionally show "In All Lists"
        const allIntersection = computeIntersection(Object.values(idSets));
        console.log('Intersection of all lists:', Array.from(allIntersection)); // Debug log for intersection
        const allListsSection = document.getElementById('allLists');
        if (listNames.length >= 3) {
          allListsSection.classList.remove('hidden');
          displayIDs('all', allIntersection);
        } else {
          allListsSection.classList.add('hidden');
        }

        // Setup comparison dropdowns if 3+ lists
        const comparisonSelect = document.getElementById('comparisonSelect');
        if (listNames.length >= 3) {
          comparisonSelect.classList.remove('hidden');
          const firstSelect = document.getElementById('firstList');
          const secondSelect = document.getElementById('secondList');

          firstSelect.innerHTML = listNames.map((name, i) => `<option value="${name}" ${i === 0 ? 'selected' : ''}>${name}</option>`).join('');
          secondSelect.innerHTML = listNames.map((name, i) => `<option value="${name}" ${i === 1 ? 'selected' : ''}>${name}</option>`).join('');

          // Ensure initial comparison is displayed for the first two lists
          console.log('Updating comparison for:', listNames[0], 'and', listNames[1]); // Debug log
          updateComparison(idSets, listNames[0], listNames[1]);

        } else {
          // Hide dropdowns for 2 lists
          comparisonSelect.classList.add('hidden');
          // Directly show comparison for these two lists without dropdowns
          console.log('Updating comparison for 2 lists:', listNames[0], 'and', listNames[1]); // Debug log
          updateComparison(idSets, listNames[0], listNames[1]);
        }

        // Explicitly show results section
        const resultsSection = document.getElementById('results');
        resultsSection.classList.remove('hidden');
        console.log('Results section should now be visible'); // Debug log to confirm UI update
      });

      // Listen for dropdown changes only if dropdowns exist
      document.getElementById('firstList').addEventListener('change', (e) => {
        const secondList = document.getElementById('secondList').value;
        updateComparison(getIDSets(), e.target.value, secondList);
      });
      document.getElementById('secondList').addEventListener('change', (e) => {
        const firstList = document.getElementById('firstList').value;
        updateComparison(getIDSets(), firstList, e.target.value);
      });

      function getIDSets() {
        const idSets = {};
        Object.keys(lists).forEach(name => {
          const text = lists[name];
          const matches = text.match(/\b\d{8}\b/g) || [];
          idSets[name] = new Set(matches);
        });
        return idSets;
      }

      function computeIntersection(sets) {
        if (sets.length === 0) return new Set();
        return sets.reduce((acc, curr) => new Set([...acc].filter(x => curr.has(x))));
      }

      // Update the comparison section with space-separated IDs in textual divs
      function updateComparison(idSets, firstName, secondName) {
        document.getElementById('onlyFirstLabel').textContent = `Only in ${firstName}`;
        document.getElementById('onlySecondLabel').textContent = `Only in ${secondName}`;
        const firstSet = idSets[firstName] || new Set();
        const secondSet = idSets[secondName] || new Set();

        const both = new Set([...firstSet].filter(x => secondSet.has(x)));
        const onlyFirst = new Set([...firstSet].filter(x => !secondSet.has(x))); // Unique to first list
        const onlySecond = new Set([...secondSet].filter(x => !firstSet.has(x))); // Unique to second list

        // Debug logs to verify the computed sets
        console.log(`Comparison Debug - Both (${firstName} & ${secondName}):`, Array.from(both));
        console.log(`Comparison Debug - Only in ${firstName}:`, Array.from(onlyFirst));
        console.log(`Comparison Debug - Only in ${secondName}:`, Array.from(onlySecond));

        displayIDs('both', both);
        displayIDs('onlyFirst', onlyFirst);
        displayIDs('onlySecond', onlySecond);
      }

      // Display IDs as space-separated strings inside divs using explicit DOM manipulation
      function displayIDs(type, idSet) {
        const container = document.getElementById(`${type}IDs`);
        if (!container) {
          console.error(`Container for ${type}IDs not found in DOM`);
          return;
        }
        const ids = Array.from(idSet).sort();
        console.log(`Display Debug - Rendering IDs for ${type}:`, ids); // Debug log to confirm data before rendering
        
        // Clear existing content
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        
        // Render IDs as spans in div container
        if (ids.length > 0) {
          ids.forEach((id, index) => {
            const span = document.createElement('span');
            span.className = 'cursor-pointer hover:text-blue-400 mr-1';
            span.textContent = id;
            span.onclick = () => showIDDetails(id);
            container.appendChild(span);
            // Add a space text node between spans (except for the last one)
            if (index < ids.length - 1) {
              container.appendChild(document.createTextNode(' '));
            }
          });
          console.log(`Display Debug - Successfully rendered ${ids.length} IDs for ${type} in DOM`);
        } else {
          container.textContent = 'No IDs found.';
          console.log(`Display Debug - No IDs to render for ${type}`);
        }
        // Store the space-separated string for copy/open
        container.dataset.ids = ids.join(' ');
      }

      // Show ID details modal
      function showIDDetails(id) {
        const modal = document.getElementById('idModal');
        modal.style.display = 'block';
        document.getElementById('modalID').textContent = id;
        const foundIn = [];
        const notFoundIn = [];
        Object.keys(lists).forEach(name => {
          if (lists[name].match(new RegExp(`\\b${id}\\b`))) {
            foundIn.push(name);
          } else {
            notFoundIn.push(name);
          }
        });
        document.getElementById('foundIn').innerHTML = foundIn.length > 0 ? foundIn.map(n => `<li>${n}</li>`).join('') : '<li>None</li>';
        document.getElementById('notFoundIn').innerHTML = notFoundIn.length > 0 ? notFoundIn.map(n => `<li>${n}</li>`).join('') : '<li>None</li>';
      }

      // Close modal
      document.querySelector('.close').addEventListener('click', () => {
        document.getElementById('idModal').style.display = 'none';
      });
      window.addEventListener('click', (event) => {
        if (event.target === document.getElementById('idModal')) {
          document.getElementById('idModal').style.display = 'none';
        }
      });

      // Copy to clipboard functionality for space separated IDs
      function copyToClipboard(type) {
        const container = document.getElementById(`${type}IDs`);
        if (!container) {
          console.error(`Copy Debug - Container for ${type}IDs not found in DOM`);
          alert('Error: Container not found. Please try again after submitting.');
          return;
        }
        const text = container.dataset.ids || '';
        console.log(`Copy Debug - Type: ${type}, Text to copy: "${text}"`); // Debug log to confirm data
        if (text) {
          navigator.clipboard.writeText(text).then(() => {
            console.log(`Copy Debug - Successfully copied: "${text}"`);
            alert('Copied to clipboard!');
          }, () => {
            console.error('Copy Debug - Failed to copy.');
            alert('Failed to copy. Your browser may not support clipboard access.');
          });
        } else {
          console.warn(`Copy Debug - No IDs to copy for type: ${type}`);
          alert('No IDs to copy.');
        }
      }

      // Open URL with space-separated IDs joined by + (e.g. https://...search?keyword=12345678+23456789)
      function openURL(type) {
        const container = document.getElementById(`${type}IDs`);
        if (!container) {
          console.error(`Open URL Debug - Container for ${type}IDs not found in DOM`);
          alert('Error: Container not found. Please try again after submitting.');
          return;
        }
        const text = container.dataset.ids || '';
        console.log(`Open URL Debug - Type: ${type}, IDs for URL: "${text}"`); // Debug log to confirm data
        if (text) {
          const ids = text.split(' ').filter(Boolean);
          const url = `https://umass.campus.eab.com/search?keyword=${ids.join('+')}`;
          console.log(`Open URL Debug - Opening URL: ${url}`);
          try {
            window.open(url, '_blank');
          } catch (error) {
            console.error('Open URL Debug - Error opening URL:', error);
            alert('Failed to open URL. Please check browser permissions.');
          }
        } else {
          console.warn(`Open URL Debug - No IDs to open for type: ${type}`);
          alert('No IDs to open.');
        }
      }

      // Attach event listeners to copy and open URL buttons
      document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', () => {
          const type = button.getAttribute('data-type');
          copyToClipboard(type);
        });
      });

      document.querySelectorAll('.open-url-btn').forEach(button => {
        button.addEventListener('click', () => {
          const type = button.getAttribute('data-type');
          openURL(type);
        });
      });
    });
  </script>
</body>
</html>